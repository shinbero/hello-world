name: Image build and push.
# on: [push]
on:
  pull_request:
    # branches:
    #   - ${{ github.base_ref }}
    types: [closed]
jobs:
  Image-build:
    runs-on: ubuntu-latest
    env:
      ACR_HOST: daianatest.azurecr.io
    steps:
      - name: Check out to base_ref branch.
        uses: actions/checkout@v2
        with:
          ref: ${{ github.base_ref }}
      - run: |
          git branch -a
      - run: echo $(date +"%Y-%m-%dT%H-%M%-S%Z")
      - name: Set env - git HEAD commit ID.
        run: |
          echo "COMMIT_ID=$(git rev-parse HEAD)" >> $GITHUB_ENV
      - name: Set env - docker image name.
        run: |
          echo "IMAGE_NAME=${{ env.ACR_HOST }}/${{ github.repository }}:$(date +"%Y-%m-%dT%H-%M%-S%Z")-${{ env.COMMIT_ID }}" >> $GITHUB_ENV
      - name: Build docker image for merged code.
        run: |
          echo ${IMAGE_NAME}
          docker image build -t ${{ env.IMAGE_NAME }} .
      - name: Login to ACR.
        run: |
          docker login ${{ env.ACR_HOST }} -u ${{ secrets.acr_daianatest_username }} -p ${{ secrets.acr_daianatest_password }}
      - name: Push to ACR.
        run: |
          docker image push ${{ env.IMAGE_NAME }}
